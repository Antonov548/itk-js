trigger:
- master

jobs:

- job: 'BuildTest'
  displayName: 'Build and test'

  strategy:
    matrix:
      LinuxNode8:
        nodeVersion: '8'
      LinuxNode10:
        nodeVersion: '10'

  pool:
    imageName: 'ubuntu-16.04'

  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '$(nodeVersion).x'
    displayName: 'Install Node.js'

  - script: |
      npm install
      npm run build
    displayName: 'Build'

  - bash: |
      # To create node_modules/.cache
      chmod 777 node_modules/
      chmod -R 777 build/Testing/
      # To debug, run `./test/run.sh -d`
      ./test/run.sh
    displayName: 'Test'

- job: 'Build'
  displayName: 'Build and test'

  strategy:
    matrix:
      macOSNode8:
        imageName: 'macos-10.13'
        nodeVersion: '8'
      macOSNode10:
        imageName: 'macos-10.13'
        nodeVersion: '10'
      WindowsNode8:
        imageName: 'vs2017-win2016'
        nodeVersion: '8'
      WindowsNode10:
        imageName: 'vs2017-win2016'
        nodeVersion: '10'

  pool:
    imageName: $(imageName)

  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '$(nodeVersion).x'
    displayName: 'Install Node.js'

  - script: |
      npm install
      npm run build
    displayName: 'Build'

  - bash: |
      npm run test:node
    displayName: 'Test'
